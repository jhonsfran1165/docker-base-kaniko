image: gcr.io/kaniko-project/executor:debug

stages:
  - setup
  - triggers
  - build

services:
  # - docker:18-dind # TODO: test the docker changes with last images
  - docker:20.10-dind

variables:
  DOCKER_HOST: tcp://localhost:2375
  KUBERNETES_SERVICE_ACCOUNT_OVERWRITE: gitlab-admin

# TODO: handle cache
# cache: &global_cache
#   key: ${DOCKER_DIRECTORY}-${PROJECT}
#   paths:
#     - ${DOCKER_DIRECTORY}/${PROJECT}/kaniko/cache

build:
  stage: build
  # TODO: ignore devops to avoid changes
  except:
    - feat/devops-images
  script:
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/docker/node/Dockerfile --destination "$CI_REGISTRY_IMAGE/node:latest"
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/docker/node/frontend.Dockerfile --destination "$CI_REGISTRY_IMAGE/frontend:latest"
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/docker/openjdk/Dockerfile --destination "$CI_REGISTRY_IMAGE/openjdk:latest"

generate-config-images:
  image: python:3.8-alpine
  before_script: pip install pyyaml
  stage: setup
  only:
    - feat/devops-images
  script:
    - python templates/generate-repos.py --file build-images.yaml
  artifacts:
    paths:
      - templates/build-images.yaml
      # - /kaniko/.docker/config.json

trigger-docker-builds:
  stage: triggers
  only:
    - feat/devops-images
  trigger:
    include:
      - artifact: templates/build-images.yaml
        job: generate-config-images

# INFO: to avoid repeat this code in the different build projects, I create a template to be extended
# Also this configuration helps to avoid unnecesary check inside the build script
.docker-builds:
  stage: build
  before_script:
    # configure kaniko credentials
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
  interruptible: true
  # TODO: configure cache
  # cache:
  #   <<: *global_cache
  when: "always"
  only:
    - feat/devops-images
